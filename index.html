<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>광고 영상 시청 시 소비자 경험 설문(운영/점검 통합본)</title>
<style>
/* ===== Design Tokens ===== */
:root{
  --fg:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc; --card:#fff;
  --brand:#2563eb; --brand-900:#1e40af; --brand-50:#eef2ff;
  --radius:12px; --gap:20px; --shadow:0 2px 10px rgba(2,6,23,.04);
  --h1:1.7rem; --h2:1.28rem; --small:.9rem;
}
@media (max-width:480px){ :root{ --h1:1.58rem; --h2:1.2rem } }
html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:960px;margin:40px auto;padding:0 20px}
[hidden]{display:none!important}

/* ===== Primitives ===== */
.h1{font-size:var(--h1);font-weight:800;margin:0 0 8px}
.h2{font-size:var(--h2);font-weight:800;margin:0 0 12px}
.small{font-size:var(--small)} .muted{color:var(--muted)}
.desc{font-size:1rem;color:#000}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;margin-top:var(--gap)}
.btnbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:32px}
.btn{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer;transition:transform .06s,box-shadow .2s,border-color .2s}
.btn:hover{box-shadow:0 1px 5px rgba(2,6,23,.08);border-color:#d0d5dd}
.btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.55;cursor:not-allowed}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.primary:hover{background:var(--brand-900);border-color:var(--brand-900)}
:where(a,button,input,textarea,.btn):focus-visible{outline:2px solid transparent;box-shadow:0 0 0 3px var(--brand-50),0 0 0 5px rgba(37,99,235,.35)}
.pill{display:inline-block;background:var(--brand-50);border:1px solid var(--brand);color:var(--brand-900);border-radius:999px;padding:2px 10px;font-size:.82rem;font-weight:700}
.notice{padding:12px;border:1px solid #fde68a;background:#fffbea;color:#92400e;border-radius:10px}
.info{padding:14px;border:1px solid var(--line);background:#fcfcff;border-radius:12px}
.progress{height:8px;background:var(--line);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:var(--brand);width:0;transition:width .3s}

/* ===== Text blocks ===== */
.instructions p{margin:0 0 12px}
.instructions strong{color:var(--brand-900);font-weight:800}
.divider{height:2px;background:#111827;border-radius:2px;margin:12px 0 16px}

/* ===== Table ===== */
.grid{overflow-x:auto}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid var(--line);padding:12px;text-align:center;vertical-align:middle}
th{background:#f9fafb;font-weight:800;border-top:2px solid var(--line)}

/* Likert */
.wide-likert{table-layout:fixed;width:100%}
.wide-likert th:first-child, .wide-likert td:first-child{width:35%;text-align:left;padding-left:16px}
.wide-likert th:not(:first-child), .wide-likert td:not(:first-child){width:13%}
.wide-likert thead th:not(:first-child){font-size:1rem;line-height:1.2;}
.wide-likert thead th:not(:first-child) .small{font-size:.86rem;color:var(--muted)}

/* Inputs */
label{font-weight:700}
.pretitle{font-size:1.45rem;font-weight:900;color:#1f2937;margin:4px 0 12px}
.prereq{display:grid;grid-template-columns:1fr 1fr 1fr;gap:34px 36px}
@media (max-width:900px){.prereq{grid-template-columns:1fr 1fr}}
@media (max-width:600px){.prereq{grid-template-columns:1fr}}
.field{display:grid;gap:10px;align-content:start}
.input{width:100%;max-width:420px;min-height:48px;padding:12px 14px;background:#fff;border:1px solid var(--line);border-radius:12px;font-size:1rem}
.input::placeholder{color:#9aa3af;font-size:.98rem}
.light-group{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-height:48px;display:flex;align-items:center;max-width:420px}
.radio-col{display:flex;gap:18px;flex-wrap:wrap}
.radio-col label{display:flex;align-items:center;gap:6px;font-size:1rem}
input[type="radio"],input[type="checkbox"]{transform:scale(1.12);accent-color:var(--brand)}
.input.short{max-width:160px;min-height:48px;padding:12px 14px;font-size:1rem}

/* Slider */
.slider-wrap{max-width:100%;margin:0 auto;text-align:center}
.slider-stack{position:relative;padding-top:36px}
.range{appearance:none;width:100%;height:10px;border-radius:999px;outline:none;margin:12px 0;
  background:linear-gradient(90deg,var(--brand) var(--pct,50%),#e5e7eb var(--pct,50%));transition:background .25s ease;}
.range::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#fff;border:4px solid var(--brand);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15)}
.range::-moz-range-thumb{width:26px;height:26px;border-radius:50%;background:#fff;border:4px solid var(--brand);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15)}
.value-bubble{position:absolute;top:0;transform:translateX(-50%);background:var(--brand-900);color:#fff;padding:4px 8px;border-radius:6px;font-size:.9rem;font-weight:700}
.value-bubble:after{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:var(--brand-900)}
.slider-labels{display:flex;justify-content:space-between;font-size:.92rem;color:var(--muted);margin-top:6px}
.anchorbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
.anchor{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 12px;font-weight:700;cursor:pointer}
.anchor:hover{border-color:#cdd3de}

/* Layout bits */
.row{display:grid;gap:14px}
.row2{display:grid;grid-template-columns:1fr auto;gap:20px;align-items:center}
.video-wrap{display:grid;gap:12px}

/* Warn highlight */
tr.warn td { background:#fff5f5; }
fieldset.warn { border:2px solid #ef4444 !important; padding:12px; border-radius:10px; }
#svcBlock.warn { border:2px solid #ef4444 !important; padding:12px; border-radius:10px; }
/* inputs warn */
.input.warn { border:2px solid #ef4444 !important; }
.light-group.warn { border:2px solid #ef4444 !important; }

/* Submit status */
#submitStatus{margin-top:10px;font-size:.95rem}
#submitStatus.ok{color:#166534}
#submitStatus.err{color:#991b1b}

/* ===== DETAILS: 요인 배지 & 설명 (이 블록 전체 삭제 시 세부설명 기능 완전 제거) ===== */
/* DETAILS:START */
.factor-badge{
  display:none;
  margin-right:8px;
  padding:2px 8px;
  border-radius:999px;
  font-size:.78rem;
  font-weight:800;
  border:1px solid var(--line);
  color:#1f2937;
  background:#f9fafb;
}
/* 세부설명 ON일 때(섹션3/4)만 배지 노출 */
.show-factors .factor-badge{ display:inline-block; }
.details{margin-top:10px}
.details[hidden]{display:none!important}
/* DETAILS:END */
</style>
</head>
<body>
<div class="wrap">
  <div class="row2">
    <h1 class="h1">광고 영상 시청 시 소비자 경험 설문 <span class="pill">점검용</span></h1>
    <div style="min-width:200px">
      <div class="progress"><div id="bar"></div></div>
      <div class="muted small" id="stepLabel" style="text-align:right;margin-top:6px">1 / 4</div>
    </div>
  </div>

  <!-- ==================== 섹션 1 ==================== -->
  <section id="sec1">
    <div class="card"><h2 class="h2">설문조사 안내문</h2></div>

    <div class="card">
      <div class="instructions">
        <p>안녕하십니까? 귀중한 시간을 내어 설문에 응해 주셔서 감사합니다.<br>저는 대구대학교 심리학과 최주형입니다.</p>
        <p>본 설문지는 영상 시청 과정에서 나타나는 광고와 관련된 전반적인 경험을 알아보기 위한 것입니다.</p>
        <p>제시되는 문항에는 정답이나 오답이 없으니, 평소에 느끼고 생각하시는 대로 응답해 주시면 됩니다.</p>
        <p>자신에게 꼭 맞는 응답이 없더라도 <strong>가장 가깝다고 생각되는 항목</strong>을 선택해 주시기 바랍니다.</p>
        <p>응답하신 내용은 익명으로 처리되며 연구 목적 외에는 사용되지 않습니다.</p>
        <p>또한 한 문항에는 <strong>반드시 하나의 응답만 선택</strong>해 주시고, <strong>빠짐없이 작성</strong>해 주셔야 설문이 유효하게 처리됩니다.</p>
        <p>본 설문지는 총 11문항과 약 20초 정도의 광고 영상으로 구성되어 있으며, 약 5분 정도 소요됩니다.</p>
        <p>귀하의 소중한 응답은 연구에 큰 도움이 됩니다. 참여해 주셔서 다시 한 번 감사드립니다.</p>
      </div>
      <hr class="divider">
      <div role="note" aria-label="조사자 정보">
        <div style="font-weight:800;margin-bottom:6px">대구대학교 일반대학원 심리학과</div>
        <ul style="margin:0;padding-left:18px">
          <li>지도교수 박은아 (<a href="mailto:eunap@daegu.ac.kr">eunap@daegu.ac.kr</a>)</li>
          <li>석사과정 수료 최주형 (<a href="mailto:thridworldjoy@naver.com">thridworldjoy@naver.com</a>)</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <form id="form" novalidate>
        <div class="pretitle">설문 전 필수 정보 입력</div>
        <div class="prereq">
          <div class="field">
            <label for="sid">학번 (8자리)</label>
            <input id="sid" name="sid" type="text" inputmode="numeric" pattern="^\\d{8}$" minlength="8" maxlength="8" placeholder="예: 12345678" class="input">
          </div>
          <div class="field">
            <label>성별</label>
            <div class="light-group">
              <div class="radio-col" role="radiogroup" aria-label="성별">
                <label><input type="radio" name="gender" value="남" required> 남</label>
                <label><input type="radio" name="gender" value="여"> 여</label>
              </div>
            </div>
          </div>
          <div class="field">
            <label for="age">나이</label>
            <input id="age" name="age" type="number" min="14" max="99" placeholder="예: 23" class="input short">
          </div>
        </div>
      </form>
      <div class="btnbar">
        <button class="btn primary" data-next="1" id="next1">다음</button>
        <!-- FORCE-NEXT:START -->
        <button class="btn" data-force>강제 다음 →</button>
        <!-- FORCE-NEXT:END -->
      </div>
    </div>
  </section>

  <!-- ==================== 섹션 2 ==================== -->
  <section id="sec2" class="card" hidden>
    <h2 class="h2">광고 영상 시청</h2>

    <div class="info" style="margin-bottom:14px">
      <div style="font-weight:800;margin-bottom:6px">브랜드 안내</div>
      <div style="line-height:1.75">
        <strong>Sunshine</strong>는 매일의 순간에 신선한 빛을 전하는 주스 브랜드입니다.<br>
        <strong>“Fresh Sunlight in Every Glass”</strong>라는 메시지처럼, 한 잔의 주스 속에 건강하고 활기찬 태양의 에너지를 담아 전달합니다.
      </div>
    </div>

    <p class="notice" id="aiNotice">⚠️ 안내 문구가 여기에 표시됩니다.</p>

    <div class="video-wrap">
      <video id="adVideo" width="100%" height="auto" controls playsinline preload="metadata">
        <source id="adSrc" src="" type="video/mp4">해당 브라우저는 video 태그를 지원하지 않습니다.
      </video>
      <div class="muted small" id="chosenInfo"></div>
    </div>

    <div class="btnbar">
      <button class="btn" data-prev>이전</button>
      <button class="btn primary" data-next="2" id="next2" disabled aria-disabled="true" title="영상을 끝까지 시청하면 활성화됩니다">다음</button>
      <!-- FORCE-NEXT:START -->
      <button class="btn" data-force>강제 다음 →</button>
      <!-- FORCE-NEXT:END -->
      <!-- DETAILS:START -->
      <button class="btn" id="toggleDetails2" type="button">세부설명</button>
      <!-- DETAILS:END -->
    </div>

    <!-- DETAILS:START -->
    <div id="details2" class="info details" hidden>
      <div style="font-weight:800;margin-bottom:6px">자극 코드 해석</div>
      <div class="small" id="codeExpl">
        <p style="margin:6px 0"><b>A/B/C</b> = 제작 주체 구분</p>
        <ul style="margin:0 0 8px 18px">
          <li><b>A</b>: 100% AI 자동 제작</li>
          <li><b>B</b>: 광고 전문가가 AI를 <u>활용</u>하여 제작</li>
          <li><b>C</b>: 광고 전문가만으로 제작(AI 미활용)</li>
        </ul>
        <p style="margin:6px 0"><b>H/L</b> = 독창성(Originality) 수준</p>
        <ul style="margin:0 0 0 18px">
          <li><b>H</b>: 고(High) 독창성</li>
          <li><b>L</b>: 저(Low) 독창성</li>
        </ul>
    </div>
    <!-- DETAILS:END -->
  </section>

  <!-- ==================== 섹션 3 ==================== -->
  <section id="sec3" hidden>
    <div class="card"><h2 class="h2">영상 시청 후 경험 평가</h2></div>

    <div class="card">
      <fieldset class="row">
        <legend><strong>1.</strong> 이 광고 시작부 또는 화면 하단에 어떤 안내 문구가 표시되었나요?</legend>
        <label><input type="radio" name="manip1" value="전문가만" required> 광고 전문가가 AI 없이 제작</label>
        <label><input type="radio" name="manip1" value="전문가+AI"> 광고 전문가가 AI를 활용하여 제작</label>
        <label><input type="radio" name="manip1" value="100%AI"> 100% AI 자동 제작</label>
        <label><input type="radio" name="manip1" value="기타"> 기타 안내 문구</label>
        <label><input type="radio" name="manip1" value="모름"> 기억나지 않음</label>
      </fieldset>
    </div>

    <div class="card">
      <div class="row">
        <div><strong>2.</strong> 당신이 보기에, 이 광고 제작에서 광고 전문가의 개입 정도는 어느 정도였습니까?</div>

        <div class="slider-wrap" aria-label="전문가 개입 정도 슬라이더">
          <div class="slider-stack">
            <output id="valBubble" class="value-bubble" for="involve" aria-live="polite">5</output>
            <input id="involve" class="range" type="range"
                   min="0" max="10" step="1" value="5"
                   aria-label="전문가 개입 정도 0에서 10까지">
          </div>

          <div class="anchorbar" role="group" aria-label="빠른 선택">
            <button type="button" class="anchor" data-anchor="0">0</button>
            <button type="button" class="anchor" data-anchor="5">5</button>
            <button type="button" class="anchor" data-anchor="10">10</button>
          </div>

          <div class="desc" style="margin-top:8px">
            0= 전혀없음(AI 완전 제작) ||| 5= 전문가와 AI 비슷함 ||| 10= 매우 큼(전문가 완전 제작)
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <p class="desc"><strong>3.</strong> 아래 문항들은 <strong>방금 시청한 영상과 제품에 대해 느끼신 점</strong>을 묻습니다. 정답이나 오답은 없으며, 느끼신 대로 응답해 주시면 됩니다.</p>
      <div class="grid" style="margin-top:8px">
        <table class="compact wide-likert">
          <thead>
            <tr>
              <th>문항</th>
              <th>1<br><span class="small">전혀 아니다</span></th>
              <th>2</th>
              <th>3<br><span class="small">보통이다</span></th>
              <th>4</th>
              <th>5<br><span class="small">매우 그렇다</span></th>
            </tr>
          </thead>
          <tbody id="likertBody"></tbody>
        </table>
      </div>
      <div class="btnbar">
        <button class="btn" data-prev>이전</button>
        <button class="btn primary" data-next="3">다음</button>
        <!-- FORCE-NEXT:START -->
        <button class="btn" data-force>강제 다음 →</button>
        <!-- FORCE-NEXT:END -->
        <!-- DETAILS:START -->
        <button class="btn" id="toggleDetails3" type="button">세부설명</button>
        <!-- DETAILS:END -->
      </div>

      <!-- DETAILS:START -->
      <div class="info details" style="margin-top:8px">
        <div style="font-weight:800;margin-bottom:6px">요인 안내</div>
        <div class="small">
          <b>진정성</b>, <b>독창성</b>, <b>광고 태도</b>, <b>구매의도</b> (세부설명 버튼으로 문항 옆 배지 표시를 On/Off 합니다. 응답·제출 로직에는 영향이 없습니다.)
        </div>
      </div>
      <!-- DETAILS:END -->
    </div>
  </section>

  <!-- ==================== 섹션 4 ==================== -->
  <section id="sec4" hidden>
    <div class="card"><h2 class="h2">생성형 AI 관련 인식 및 경험</h2></div>

    <div class="card">
      <p class="desc"><strong>4.</strong> 아래 문항들은 귀하의 생성형 AI에 대한 이해와 인식을 묻는 질문입니다. 정답이나 오답은 없으며, 느끼신 대로 응답해 주시면 됩니다.</p>
      <div class="grid" style="margin-top:8px">
        <table class="compact wide-likert">
          <thead>
            <tr>
              <th style="text-align:left">문항</th>
              <th>1<br><span class="small">전혀 아니다</span></th>
              <th>2</th>
              <th>3<br><span class="small">보통이다</span></th>
              <th>4</th>
              <th>5<br><span class="small">매우 그렇다</span></th>
            </tr>
          </thead>
          <tbody id="aiLitBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <fieldset class="row">
        <legend><strong>5.</strong> 본인의 생성형 AI 사용 경험 수준은 어느 정도입니까?</legend>
        <label><input type="radio" name="AIUSE" value="1" required> 전혀 없다</label>
        <label><input type="radio" name="AIUSE" value="2"> 한두 번 사용해 본 적이 있다 (1~2회 이하)</label>
        <label><input type="radio" name="AIUSE" value="3"> 가끔 사용한다 (월 1회 이상)</label>
        <label><input type="radio" name="AIUSE" value="4"> 자주 사용한다 (주 1회 이상)</label>
        <label><input type="radio" name="AIUSE" value="5"> 매우 자주 사용한다 (거의 매일)</label>
      </fieldset>

      <div id="svcBlock" class="row" hidden style="margin-top:12px">
        <div><strong>사용해 본 생성형 AI 서비스</strong> (복수선택)</div>
        <label><input type="checkbox" name="AIsvc" value="chat"> 텍스트/대화형 AI (ChatGPT, Gemini 등)</label>
        <label><input type="checkbox" name="AIsvc" value="image"> 이미지 생성 AI (Midjourney, SD 등)</label>
        <label><input type="checkbox" name="AIsvc" value="video"> 영상 생성 AI (Sora, Runway, Kling 등)</label>
        <label><input type="checkbox" name="AIsvc" value="audio"> 음악/오디오 AI (Suno, Udio 등)</label>
      </div>

      <div class="btnbar">
        <button class="btn" data-prev>이전</button>
        <button class="btn primary" id="submitBtn">설문 제출</button>
        <!-- FORCE-NEXT:START -->
        <button class="btn" data-force>강제 다음(제거예정) →</button>
        <!-- FORCE-NEXT:END -->
      </div>
      <div id="submitStatus" aria-live="polite"></div>
    </div>
  </section>

  <!-- ==================== 완료 ==================== -->
  <section id="done" class="card" hidden>
    <h2 class="h2">제출 완료</h2>
    <p>응답해 주셔서 감사합니다.</p>
    <p class="small muted" id="serverMsg"></p>
    <pre id="dump" class="small" style="white-space:pre-wrap;background:#f0f4f7;border:1px solid var(--line);padding:12px;border-radius:10px;color:#444" hidden></pre>
  </section>
</div>

<script>
/* =============================================================
   운영 모드 전환 가이드
   1) 강제 다음 제거: <!-- FORCE-NEXT:START --> ~ <!-- FORCE-NEXT:END --> 블록 전체 삭제
   2) 세부설명 제거:   <!-- DETAILS:START --> ~ <!-- DETAILS:END -->  블록 전체 삭제
   ============================================================= */

/* ===== CONFIG (백엔드 URL만 교체하세요) ===== */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxtBU7CtqXQG2uo9N5uIMVaJPFgxAVAUmk1w9k9fGqyyLAG9HbW4Vjjr2eZrrVsfCEYQg/exec";

/* ===== helpers ===== */
const $=(s,sc=document)=>sc.querySelector(s), $$=(s,sc=document)=>[...sc.querySelectorAll(s)];
const steps=["sec1","sec2","sec3","sec4"]; let cur=0;
const bar=$("#bar"), stepLabel=$("#stepLabel");
function goTo(i){
  cur=i;
  steps.forEach((id,k)=>$("#"+id).hidden=k!==i);
  $("#done").hidden=true;
  bar.style.width=((i+1)/steps.length*100)+'%';
  stepLabel.textContent=`${i+1} / ${steps.length}`;
  if(i===3) toggleSvc();
  if(i===2) requestAnimationFrame(()=>requestAnimationFrame(updateSlider));
  scrollTo({top:0,behavior:"smooth"});
}

const valRadio = n => { const e = $(`input[name='${n}']:checked`); return e ? e.value : ""; };
const valChecks = n => $$(`input[name='${n}']:checked`).map(x=>x.value);
function clearWarns(scope=document){
  $$("tr.warn", scope).forEach(tr=>tr.classList.remove("warn"));
  $$("fieldset.warn", scope).forEach(fs=>fs.classList.remove("warn"));
  $("#svcBlock")?.classList.remove("warn");
  $$(".input.warn", scope).forEach(inp=>inp.classList.remove("warn"));
  $(".light-group")?.classList.remove("warn");
}

/* ===== 요인 라벨(한글) ===== */
const FACTOR_LABELS = {
  AUTH: "진정성",
  ORIG: "독창성",
  ATT:  "광고 태도",
  PI:   "구매의도",
  AILIT:"AI 리터러시"
};

/* ===== dynamic tables ===== */
const likertItems=[
  "이 광고는 제품의 특성을 왜곡하지 않고 보여준다.",
  "이 광고는 소비자를 속이려는 의도가 없어 보인다.",
  "이 광고는 신뢰할 수 있다.",
  "이 광고의 표현은 자연스럽다.",
  "이 광고는 인간의 개입이 반영되어 있다.",
  "이 광고는 기존의 광고들과는 다른 독특한 접근을 보여준다.",
  "이 광고는 참신한 시각적 표현을 담고 있다.",
  "이 광고는 예측하기 어려운 요소를 포함하고 있다.",
  "이 광고는 브랜드와 관련성이 있다.",
  "이 광고는 브랜드와 잘 어울린다.",
  "이 광고는 진부하다. <span class='muted small'>(역채점)</span>",
  "이 광고는 마음에 든다.",
  "이 광고는 긍정적인 인상을 준다.",
  "이 광고는 매력적이다.",
  "이 광고에서 나온 제품을 구매할 가능성이 있다.",
  "이 광고는 나의 구매 욕구를 자극한다.",
  "나는 이 제품을 다른 사람에게 추천하고 싶다."
];
const groups = ["AUTH","AUTH","AUTH","AUTH","AUTH",
                "ORIG","ORIG","ORIG","ORIG","ORIG","ORIG",
                "ATT","ATT","ATT","PI","PI","PI"];
const counters = { AUTH:0, ORIG:0, ATT:0, PI:0 };

$("#likertBody").innerHTML = likertItems.map((t,i)=>{
  const g = groups[i]; counters[g] += 1; const name = g + counters[g];
  return `<tr data-name="${name}">
            <td><span class="factor-badge">${FACTOR_LABELS[g]||g}</span>${t}</td>
            ${Array.from({length:5},(_,k)=>`<td><input type="radio" name="${name}" value="${k+1}"></td>`).join("")}
          </tr>`;
}).join("");

const aiLitItems=[
  "나는 AI가 학습한 데이터를 활용해 글이나 이미지를 만들어낸다는 것을 알고 있다.",
  "나는 AI가 만든 콘텐츠와 사람이 만든 콘텐츠를 비교해보고 스스로 판단할 수 있다.",
  "나는 AI가 만든 결과물을 신뢰할 수 있다."
];
$("#aiLitBody").innerHTML=aiLitItems.map((t,i)=>`
  <tr>
    <td><span class="factor-badge">${FACTOR_LABELS.AILIT}</span>${t}</td>
    ${Array.from({length:5},(_,k)=>`<td><input type="radio" name="AILIT${i+1}" value="${k+1}"></td>`).join("")}
  </tr>`).join("");

function requiredLikertNames(){
  const req=[];
  for (let i=1;i<=counters.AUTH;i++) req.push(`AUTH${i}`);
  for (let i=1;i<=counters.ORIG;i++) req.push(`ORIG${i}`);
  for (let i=1;i<=counters.ATT;i++)  req.push(`ATT${i}`);
  for (let i=1;i<=counters.PI;i++)   req.push(`PI${i}`);
  return req;
}

/* ===== Navigation (prev/next only) ===== */
document.addEventListener("click",e=>{
  const prevBtn = e.target.closest('[data-prev]');
  const nextBtn = e.target.closest('[data-next]');
  const forceBtn = e.target.closest('[data-force]');

  if(prevBtn){ e.preventDefault(); return goTo(Math.max(cur-1,0)); }
  if(forceBtn){ e.preventDefault(); return goTo(Math.min(cur+1,steps.length-1)); } // FORCE-NEXT (운영 시 블록 삭제)
  if(!nextBtn) return;

  e.preventDefault();
  const target=+nextBtn.dataset.next;
  if(target===1 && !validateS1()) return;         // 섹션1 -> 섹션2
  if(target===3 && !validateSec3()) return;       // 섹션3 -> 섹션4
  if(nextBtn.id==="next2" && nextBtn.disabled) return; // 영상 미시청
  goTo(Math.min(target,steps.length-1));
});

/* ===== Validation ===== */
function validateS1(){
  clearWarns($("#sec1"));
  const sidEl = $("#sid");
  const ageEl = $("#age");

  const sidOk = /^\d{8}$/.test(sidEl.value.trim());
  if(!sidOk){
    sidEl.classList.add("warn");
    sidEl.setCustomValidity("학번은 숫자 8자로 정확히 입력해 주세요.");
    sidEl.reportValidity();
    return false;
  }
  sidEl.classList.remove("warn"); sidEl.setCustomValidity("");

  const genderOk = !!$("input[name='gender']:checked");
  if(!genderOk){
    $(".light-group")?.classList.add("warn");
    alert("성별을 선택해 주세요.");
    return false;
  }
  $(".light-group")?.classList.remove("warn");

  const ageVal = ageEl.value.trim();
  const ageOk = ageVal !== "" && +ageVal >= 14 && +ageVal <= 99;
  if(!ageOk){
    ageEl.classList.add("warn");
    ageEl.setCustomValidity("나이는 14~99 사이의 숫자로 입력해 주세요.");
    ageEl.reportValidity();
    return false;
  }
  ageEl.classList.remove("warn"); ageEl.setCustomValidity("");
  return true;
}

function validateSec3(){
  clearWarns(document);
  let ok=true;

  if(!valRadio("manip1")){
    const fs1 = $$("fieldset").find(fs => fs.querySelector("input[name='manip1']"));
    fs1 && fs1.classList.add("warn");
    ok=false;
  }

  requiredLikertNames().forEach(n=>{
    if(!valRadio(n)){
      const tr = $(`tr[data-name='${n}']`);
      tr && tr.classList.add("warn");
      ok=false;
    }
  });

  if(!ok){
    const first = document.querySelector("tr.warn, fieldset.warn");
    first?.scrollIntoView({behavior:"smooth", block:"center"});
    alert("섹션 3의 미응답 항목을 완료해 주세요.");
  }
  return ok;
}

/* ===== stimuli & video gate ===== */
const stimuli=[
  {file:"A_H.mp4",code:"A_H",label:"⚠️ 본 영상은 생성형 AI에 의해 전적으로 자동 제작된 콘텐츠입니다."},
  {file:"A_L.mp4",code:"A_L",label:"⚠️ 본 영상은 생성형 AI에 의해 전적으로 자동 제작된 콘텐츠입니다."},
  {file:"B_H.mp4",code:"B_H",label:"⚠️ 해당 영상은 광고 전문가가 생성형 AI를 활용하여 제작한 콘텐츠입니다."},
  {file:"B_L.mp4",code:"B_L",label:"⚠️ 해당 영상은 광고 전문가가 생성형 AI를 활용하여 제작한 콘텐츠입니다."},
  {file:"C_H.mp4",code:"C_H",label:"⚠️ 해당 영상은 전적으로 광고 전문가에 의해 제작되었으며, 생성형 AI는 활용되지 않았습니다."},
  {file:"C_L.mp4",code:"C_L",label:"⚠️ 해당 영상은 전적으로 광고 전문가에 의해 제작되었으며, 생성형 AI는 활용되지 않았습니다."}
];
const pick=new URLSearchParams(location.search).get("pick");
const chosen=stimuli.find(s=>s.code===pick)||stimuli[Math.floor(Math.random()*stimuli.length)];
$("#adSrc").src=chosen.file; $("#adVideo").load(); $("#aiNotice").textContent=chosen.label; $("#chosenInfo").textContent=`(제거예정)선정된 자극: ${chosen.code} (파일: ${chosen.file})`;

const next2=$("#next2"); let watched=false;
$("#adVideo").addEventListener("timeupdate",e=>{
  const v=e.target;if(!v.duration) return;
  if(v.currentTime/v.duration>=.95){watched=true;next2.disabled=false;next2.title="";}
});
$("#adVideo").addEventListener("ended",()=>{watched=true;next2.disabled=false;next2.title="";});

/* ===== slider visuals ===== */
const range=$("#involve"), bubble=$("#valBubble");
function updateSlider(){
  const min=+range.min, max=+range.max, val=+range.value, pct=(val-min)/(max-min);
  bubble.textContent=val;
  range.style.setProperty("--pct",(pct*100)+"%");
  const w=range.offsetWidth, x=w*pct;
  bubble.style.left=x+"px";
}
["input","change"].forEach(ev=>range.addEventListener(ev,updateSlider));
addEventListener("resize",updateSlider,{passive:true});

/* 앵커 버튼 */
$$(".anchor").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const v=+btn.dataset.anchor;
    range.value=String(v);
    range.dispatchEvent(new Event("input",{bubbles:true}));
    range.dispatchEvent(new Event("change",{bubbles:true}));
    range.focus({preventScroll:true});
  });
});

/* ===== svc block toggle ===== */
function toggleSvc(){
  const v=$("input[name='AIUSE']:checked");
  const use1 = !!(v && v.value==="1");
  $("#svcBlock").hidden = !v || use1 ? true : false;
  if(use1){
    $$("input[name='AIsvc']:checked").forEach(c=>c.checked=false);
    $("#svcBlock").classList.remove("warn");
  }
}
$$("input[name='AIUSE']").forEach(r=>r.addEventListener("change",toggleSvc));

/* ===== DETAILS 토글 ===== */
/* DETAILS:START */
const toggleDetails2Btn = $("#toggleDetails2");
const details2 = $("#details2");
toggleDetails2Btn?.addEventListener("click", ()=>{
  const on = details2.hasAttribute("hidden");
  if (on) details2.removeAttribute("hidden"); else details2.setAttribute("hidden","true");
  toggleDetails2Btn.textContent = on ? "세부설명 숨기기" : "세부설명(제거예정)";
});

const toggleDetails3Btn = $("#toggleDetails3");
toggleDetails3Btn?.addEventListener("click", ()=>{
  // 섹션3/4 모두에 요인 배지 적용
  document.body.classList.toggle("show-factors");
  const on = document.body.classList.contains("show-factors");
  toggleDetails3Btn.textContent = on ? "세부설명 숨기기" : "세부설명";
});
/* DETAILS:END */

/* ===== Submit to Backend ===== */
function uuid(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;
    const v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
const SESSION_ID = sessionStorage.getItem("sess_id") || (sessionStorage.setItem("sess_id", uuid()), sessionStorage.getItem("sess_id"));

function getPayload(){
  const AUTH = Object.fromEntries(Array.from({length:counters.AUTH},(_,i)=>[`AUTH${i+1}`, valRadio(`AUTH${i+1}`)]));
  const ORIG = Object.fromEntries(Array.from({length:counters.ORIG},(_,i)=>[`ORIG${i+1}`, valRadio(`ORIG${i+1}`)]));
  const ATT  = Object.fromEntries(Array.from({length:counters.ATT}, (_,i)=>[`ATT${i+1}`,  valRadio(`ATT${i+1}`)]));
  const PI   = Object.fromEntries(Array.from({length:counters.PI},  (_,i)=>[`PI${i+1}`,   valRadio(`PI${i+1}`)]));

  return {
    meta:{
      session_id: SESSION_ID,
      user_agent: navigator.userAgent,
      client_time_iso: new Date().toISOString(),
      picked_code: chosen.code,
      picked_file: chosen.file,
      picked_label: chosen.label,
      video_watched_95: watched
    },
    section1:{
      student_id: $("#sid").value.trim(),
      gender: valRadio("gender"),
      age: $("#age").value
    },
    section3:{
      manipulation_seen: valRadio("manip1"),
      involvement_0to10: +range.value,
      AUTH, ORIG, ATT, PI
    },
    section4:{
      AILIT:{
        AILIT1: valRadio("AILIT1"),
        AILIT2: valRadio("AILIT2"),
        AILIT3: valRadio("AILIT3"),
      },
      AIUSE: valRadio("AIUSE"),
      AIsvc: valChecks("AIsvc")
    }
  };
}

function showSubmitStatus(msg, ok=false){
  const s=$("#submitStatus");
  s.textContent=msg;
  s.className = ok ? "ok" : "err";
}
function disableSubmit(disabled){ $("#submitBtn").disabled = disabled; }

/* ===== final validation ===== */
function validateAllRequired(){
  clearWarns(document);
  const missing = [];

  // 섹션1
  const sidEl = $("#sid");
  const ageEl = $("#age");

  const sidOk = /^\d{8}$/.test(sidEl.value.trim());
  if(!sidOk){
    sidEl.classList.add("warn");
    sidEl.setCustomValidity("학번은 숫자 8자로 정확히 입력해 주세요.");
    sidEl.reportValidity();
    missing.push({el:sidEl});
  } else { sidEl.classList.remove("warn"); sidEl.setCustomValidity(""); }

  const genderOk = !!$("input[name='gender']:checked");
  if(!genderOk){
    const gw = $(".light-group");
    gw?.classList.add("warn");
    missing.push({el:gw || $("#sec1")});
  } else { $(".light-group")?.classList.remove("warn"); }

  const ageVal = ageEl.value.trim();
  const ageOk = ageVal !== "" && +ageVal >= 14 && +ageVal <= 99;
  if(!ageOk){
    ageEl.classList.add("warn");
    ageEl.setCustomValidity("나이는 14~99 사이의 숫자로 입력해 주세요.");
    ageEl.reportValidity();
    missing.push({el:ageEl});
  } else { ageEl.classList.remove("warn"); ageEl.setCustomValidity(""); }

  // 섹션3
  if(!valRadio("manip1")){
    const fs1 = $$("fieldset").find(fs => fs.querySelector("input[name='manip1']"));
    fs1 && fs1.classList.add("warn");
    missing.push({el:fs1});
  }
  requiredLikertNames().forEach(n=>{
    if(!valRadio(n)){
      const tr = $(`tr[data-name='${n}']`);
      tr && tr.classList.add("warn");
      missing.push({el:tr});
    }
  });

  // 섹션4
  ["AILIT1","AILIT2","AILIT3"].forEach((n,i)=>{
    if(!valRadio(n)){
      const tr = $(`#aiLitBody tr:nth-child(${i+1})`);
      tr && tr.classList.add("warn");
      missing.push({el:tr});
    }
  });

  if(!valRadio("AIUSE")){
    const fs2 = $$("fieldset").find(fs => fs.querySelector("input[name='AIUSE']"));
    fs2 && fs2.classList.add("warn");
    missing.push({el:fs2});
  } else {
    const aiuse = valRadio("AIUSE");
    if (aiuse !== "1") {
      const svcChosen = valChecks("AIsvc");
      if (svcChosen.length === 0) {
        const svc = $("#svcBlock");
        if (svc && !svc.hidden) svc.classList.add("warn");
        missing.push({el:svc || $("#sec4")});
      } else { $("#svcBlock")?.classList.remove("warn"); }
    } else { $("#svcBlock")?.classList.remove("warn"); }
  }

  if(missing.length){
    const first = missing[0].el;
    first?.scrollIntoView?.({behavior:"smooth", block:"center"});
    alert(`미응답 문항이 ${missing.length}개 있습니다. 붉게 표시된 항목을 채워주세요.`);
    return false;
  }
  return true;
}

/* ===== robust POST with timeout & retry ===== */
async function postJSON(url, data, {timeoutMs=10000, retries=2}={}){
  const body = "data=" + encodeURIComponent(JSON.stringify(data)); // 프리플라이트 회피
  for(let attempt=0; attempt<=retries; attempt++){
    const ac = new AbortController();
    const t  = setTimeout(()=>ac.abort(), timeoutMs);
    try{
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body,
        credentials:"omit",
        cache:"no-store",
        signal: ac.signal
      });
      clearTimeout(t);
      const text = await res.text();
      let json; try{ json = JSON.parse(text); } catch{ json = { ok:true }; }
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return { ok:true, json };
    }catch(err){
      clearTimeout(t);
      if(attempt===retries) return { ok:false, error:String(err) };
      await new Promise(r=>setTimeout(r, 400*(attempt+1)));
    }
  }
}

/* ===== submit ===== */
let submitted = false;
$("#submitBtn")?.addEventListener("click",async e=>{
  e.preventDefault();
  if(submitted){ return; }
  if(!validateAllRequired()) return;

  submitted = true;
  disableSubmit(true);
  showSubmitStatus("제출 중입니다… 잠시만 기다려 주세요.");

  const payload = getPayload();
  const result = await postJSON(BACKEND_URL, payload);

  if(result.ok){
    const serverText = result.json?.message || result.json?.status || "서버 저장 성공";
    showSubmitStatus("제출이 완료되었습니다.", true);

    steps.forEach(id=>$("#"+id).hidden=true);
    $("#done").hidden=false; bar.style.width="100%"; stepLabel.textContent="완료";
    $("#serverMsg").textContent = `서버 응답: ${serverText}${result.json?.id ? " (id: "+result.json.id+")" : ""}`;

    // JSON 출력 숨김
    const dump = $("#dump");
    if (dump) { dump.textContent = ""; dump.setAttribute("hidden","true"); }

    scrollTo({top:0,behavior:"smooth"});
  }else{
    showSubmitStatus("서버 전송에 실패했습니다. 네트워크를 확인 후 다시 시도해 주세요.", false);
    alert("전송 실패: " + (result.error||"알 수 없는 오류"));
    disableSubmit(false);
    submitted = false;
  }
});

/* ===== init ===== */
goTo(0);
const age=$("#age"); age?.addEventListener("focus",()=>{if(!age.value) age.value=20},{once:true});
updateSlider();
</script>
</body>
</html>
